<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gestão</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }

    main {
      flex: 1;
    }

    .card:hover {
      transform: scale(1.02);
      transition: transform 0.3s;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .dashboard-card {
      border-radius: 1rem;
    }

    #user-section {
      display: none;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="bg-primary text-white py-4 mb-3">
    <div class="container text-center">
      <h1 class="mb-0">Sistema de Gestão</h1>
      <p class="lead">Bem-vindo! Aceda facilmente à gestão de utilizadores, tarefas e tipos de tarefas.</p>
      
      <!-- User Section -->
      <div id="user-section" class="mt-3">
        <div class="d-flex justify-content-center align-items-center gap-3">
          <span id="user-info">
            <i class="bi bi-person-check-fill"></i>
            <span id="user-name"></span> (<span id="user-role"></span>)
          </span>
          <button class="btn btn-sm btn-outline-light" onclick="authService.logout()">
            <i class="bi bi-box-arrow-right"></i> Sair
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard Stats -->
    <section class="row text-center mb-5" id="stats-section" style="display: none;">
      <div class="col-md-4">
        <div class="card dashboard-card border-primary">
          <div class="card-body">
            <i class="bi bi-people-fill fs-1 text-primary"></i>
            <h5 class="mt-2" id="users-count">- Utilizadores</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card dashboard-card border-success">
          <div class="card-body">
            <i class="bi bi-list-check fs-1 text-success"></i>
            <h5 class="mt-2" id="tasks-count">- Tarefas</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card dashboard-card border-warning">
          <div class="card-body">
            <i class="bi bi-tags-fill fs-1 text-warning"></i>
            <h5 class="mt-2" id="types-count">- Tipos de Tarefas</h5>
          </div>
        </div>
      </div>
    </section>

    <!-- Welcome Message for Non-Authenticated Users -->
    <section class="text-center mb-5" id="welcome-section">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow">
            <div class="card-body p-5">
              <i class="bi bi-shield-check fs-1 text-primary mb-3"></i>
              <h2 class="mb-3">Sistema de Gestão de Tarefas</h2>
              <p class="lead mb-4">
                Para aceder às funcionalidades do sistema, é necessário iniciar sessão.
              </p>
              <p class="text-muted mb-4">
                Este sistema permite gerir utilizadores, tarefas e tipos de tarefas de forma eficiente e segura.
              </p>
              <div class="row text-start">
                <div class="col-md-6">
                  <h5><i class="bi bi-check-circle text-success"></i> Funcionalidades</h5>
                  <ul class="list-unstyled">
                    <li><i class="bi bi-arrow-right text-primary"></i> Gestão de Utilizadores</li>
                    <li><i class="bi bi-arrow-right text-primary"></i> Gestão de Tarefas</li>
                    <li><i class="bi bi-arrow-right text-primary"></i> Tipos de Tarefas</li>
                    <li><i class="bi bi-arrow-right text-primary"></i> Dashboard com Estatísticas</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h5><i class="bi bi-shield-check text-success"></i> Segurança</h5>
                  <ul class="list-unstyled">
                    <li><i class="bi bi-arrow-right text-primary"></i> Autenticação Segura</li>
                    <li><i class="bi bi-arrow-right text-primary"></i> Controlo de Permissões</li>
                    <li><i class="bi bi-arrow-right text-primary"></i> Logs de Auditoria</li>
                    <li><i class="bi bi-arrow-right text-primary"></i> Validação de Dados</li>
                  </ul>
                </div>
              </div>
              <div class="mt-4">
                <button class="btn btn-primary btn-lg" onclick="authService.showLoginModal()">
                  <i class="bi bi-person-circle"></i> Iniciar Sessão
                </button>
              </div>
              <div class="mt-3 text-muted">
                <small>
                  <strong>Credenciais de teste:</strong> admin / admin123
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Navigation Cards (Only for authenticated users) -->
    <section class="row g-4 justify-content-center mb-5" id="navigation-section" style="display: none;">
      <div class="col-md-4">
        <div class="card shadow-sm text-center dashboard-card">
          <div class="card-body">
            <i class="bi bi-person-gear fs-2 text-primary"></i>
            <h5 class="card-title mt-2">Gestão de Utilizadores</h5>
            <p class="card-text">Adicione, edite e remova utilizadores do sistema.</p>
            <a href="/users" class="btn btn-primary">Aceder</a>
            <div class="mt-2">
              <small class="text-muted">Requer permissões de Admin/Gestor</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm text-center dashboard-card">
          <div class="card-body">
            <i class="bi bi-kanban-fill fs-2 text-success"></i>
            <h5 class="card-title mt-2">Gestão de Tarefas</h5>
            <p class="card-text">Organize e atribua tarefas de forma eficiente.</p>
            <a href="/tasks" class="btn btn-success">Aceder</a>
            <div class="mt-2">
              <small class="text-muted">Disponível para todos os utilizadores</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm text-center dashboard-card">
          <div class="card-body">
            <i class="bi bi-tags fs-2 text-warning"></i>
            <h5 class="card-title mt-2">Gestão de Tipos de Tarefas</h5>
            <p class="card-text">Defina e classifique os diferentes tipos de tarefas.</p>
            <a href="/types" class="btn btn-warning text-white">Aceder</a>
            <div class="mt-2">
              <small class="text-muted">Requer permissões de Admin/Gestor</small>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-auto">
    <div class="container">
      <p class="mb-1">&copy; 2025 Sistema de Gestão</p>
      <small>Projeto desenvolvido por: David Fernandes, João Rôlo, Sorin Revenco</small>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="/js/services/api.js"></script>
  <script src="/js/services/auth.js"></script>
  <script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await authService.checkAuthStatus();
      updatePageContent();
      
      if (authService.isLoggedIn) {
        await loadDashboardStats();
      }
    });

    function updatePageContent() {
      const welcomeSection = document.getElementById('welcome-section');
      const navigationSection = document.getElementById('navigation-section');
      const statsSection = document.getElementById('stats-section');
      const userSection = document.getElementById('user-section');

      if (authService.isLoggedIn) {
        welcomeSection.style.display = 'none';
        navigationSection.style.display = 'flex';
        statsSection.style.display = 'flex';
        userSection.style.display = 'block';
        
        // Update user info
        document.getElementById('user-name').textContent = authService.user.name;
        document.getElementById('user-role').textContent = authService.user.role;
      } else {
        welcomeSection.style.display = 'block';
        navigationSection.style.display = 'none';
        statsSection.style.display = 'none';
        userSection.style.display = 'none';
      }
    }

    async function loadDashboardStats() {
      try {
        // Show loading state
        document.getElementById('users-count').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Carregando...';
        document.getElementById('tasks-count').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Carregando...';
        document.getElementById('types-count').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Carregando...';

        // Load users count
        try {
          const usersResponse = await apiService.getUsers();
          if (usersResponse.success) {
            document.getElementById('users-count').textContent = `${usersResponse.count} Utilizadores`;
          } else {
            document.getElementById('users-count').textContent = '- Utilizadores';
          }
        } catch (error) {
          document.getElementById('users-count').textContent = '- Utilizadores';
        }

        // Load tasks count
        try {
          const tasksResponse = await apiService.getTasks();
          if (tasksResponse.success) {
            document.getElementById('tasks-count').textContent = `${tasksResponse.count} Tarefas`;
          } else {
            document.getElementById('tasks-count').textContent = '- Tarefas';
          }
        } catch (error) {
          document.getElementById('tasks-count').textContent = '- Tarefas';
        }

        // Load task types count
        try {
          const typesResponse = await apiService.getTaskTypes();
          if (typesResponse.success) {
            document.getElementById('types-count').textContent = `${typesResponse.count} Tipos de Tarefas`;
          } else {
            document.getElementById('types-count').textContent = '- Tipos de Tarefas';
          }
        } catch (error) {
          document.getElementById('types-count').textContent = '- Tipos de Tarefas';
        }

      } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
        showError('Erro ao carregar estatísticas do dashboard');
      }
    }

    // Utility functions for toasts
    function showError(message) {
      const toastContainer = document.querySelector(".toast-container");
      if (!toastContainer) return;

      const toastId = `toast-error-${Date.now()}`;

      const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
          <div class="toast-header bg-danger text-white">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong class="me-auto">Erro</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML("beforeend", toastHTML);

      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement);

      toastElement.addEventListener("hidden.bs.toast", () => {
        toastElement.remove();
      });

      toast.show();
    }

    function showSuccess(message) {
      const toastContainer = document.querySelector(".toast-container");
      if (!toastContainer) return;

      const toastId = `toast-success-${Date.now()}`;

      const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
          <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong class="me-auto">Sucesso</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML("beforeend", toastHTML);

      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement);

      toastElement.addEventListener("hidden.bs.toast", () => {
        toastElement.remove();
      });

      toast.show();
    }

    function showInfo(message) {
      const toastContainer = document.querySelector(".toast-container");
      if (!toastContainer) return;

      const toastId = `toast-info-${Date.now()}`;

      const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
          <div class="toast-header bg-info text-white">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong class="me-auto">Informação</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML("beforeend", toastHTML);

      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement);

      toastElement.addEventListener("hidden.bs.toast", () => {
        toastElement.remove();
      });

      toast.show();
    }

    // Auto-refresh stats every 30 seconds if user is logged in
    setInterval(() => {
      if (authService.isLoggedIn) {
        loadDashboardStats();
      }
    }, 30000);
  </script>

</body>

</html>